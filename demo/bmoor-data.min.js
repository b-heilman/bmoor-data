;(function(){
/** bmoor-data v0.0.1 **/
bMoor.make("bmoor.data.Bucket",["bmoor.data.Cascade",function(t){"use strict";function o(o,r){this.$cascade=new t(o),this._getValue=r}return{construct:o,properties:{getCascade:function(t){return this.$cascade.find(t)},getGrid:function(t){return this.getCascade().getGrid(function(t,o){return{value:o.$value,nodes:t}})},$insert:function(t){for(var o=this._getValue(t),r=this.$cascade.$insert(t);r;)r.$value?r.$value+=o:r.$value=o,r=r.getParent()},$remove:function(t){for(var o=this._getValue(t),r=this.$cascade.$remove(t);r;)r.$value-=o,r=r.getParent()},$update:function(t,o){this.$remove(t),this.$insert(o)}}}}]),bMoor.make("bmoor.data.Cascade",["bmoor.data.Grid",function(t){"use strict";function o(t,o){this.$index=t[0],this.$secondary=t.slice(1),this.$nodes={},this.getParent=function(){return o}}function r(t){var o;return t?bMoor.isArray(secondary)&&(o={},bMoor.loop(secondary,function(t,r){o[t]=r}),t=o):t={$count:0},t}function e(t){var o=[];return bMoor.object.safe(t,function(t,r){o[t]=r}),o}return{construct:o,properties:{_makeChild:function(){return new o(this.$secondary,this)},find:function(t){var o,r;return bMoor.isUndefined(arguments[0])?this:((arguments.length>1||!bMoor.isArray(t))&&(t=Array.prototype.slice.call(arguments,0)),r=t.shift(),o=this[r],bMoor.isUndefined(o)?void 0:t.length?o.find(t):o)},getNodes:function(t){return bMoor.object.values(this.$nodes)},_getGrid:function(o,r,e){var n=new t;return"$count"in o?bMoor.object.naked(this,function(t,i){var s=o[i];void 0===s&&(s=o[i]=o.$count++),n.$insert(r,s,e(t.getNodes(),t))}):bMoor.each(o,function(t,o){var i=this[o];i&&n.$insert(r,t,e(i.getNodes(),i))},this),n},getGrid:function(o,n,i){var s=new t;return bMoor.isFunction(o)&&(i=o,o=void 0,n=void 0),o=r(o),n=r(n),"$count"in o?bMoor.object.naked(this,function(t,r){var e=o[r];void 0===e&&(e=o[r]=o.$count++),s.join(t._getGrid(n,e,i))}):bMoor.each(index,function(t,o){var r=this[o];r&&s.join(r._getGrid(n,t,i))},this),s.setIndexes(e(o),e(n)),s},$insert:function(t){var o,r,e=bMoor.data.setUid(t);return this.$nodes[e]=t,this.$index?(o=bMoor.get(this.$index,t),r=this[o],r||(r=this[o]=this._makeChild()),r.$insert(t)):this},$remove:function(t){var o,r,e=bMoor.data.setUid(t);if(this.$nodes[e]){if(delete this.$nodes[e],!this.$index)return this;if(o=bMoor.get(this.$index,t),r=this[o])return r.$remove(t)}}}}}]),bMoor.make("bmoor.data.Collection",["bmoor.defer.Group","bmoor.data.Eventable",function(t,o){"use strict";function r(){var t,o;for(bMoor.data.setUid(this),t=0,o=arguments.length;o>t;t++)this.$insert(arguments[t])}return{parent:Array,construct:r,extend:[new o],properties:{_canInsert:function(t){return bMoor.data.setUid(t),!0},_insert:function(t){this.$trigger("insert",t)},_canRemove:function(){return!0},_remove:function(t){this.$trigger("remove",t)},concat:function(){var t,o,e=new r;for(e.$follow(this),t=0,o=arguments;o>t;t++)e.push(arguments[t]);return e},push:function(t){t instanceof r?this.$follow(t):this._canInsert(t)&&(Array.prototype.push.call(this,t),this._insert(t))},unshift:function(t){t instanceof r?this.$follow(t):this._canInsert(t)&&(Array.prototype.unshift.call(this,t),this._insert(t))},pop:function(){var t;return this._canRemove()&&(t=Array.prototype.pop.call(this),this._remove(t)),t},shift:function(){var t=Array.prototype.shift.call(this);return this._remove(t),t},slice:function(){var t,o,r=Array.prototype.slice.apply(this,arguments);for(t=0,o=r.length;o>t;t++)this.$remove(r[t]);return new Collection(r)},forEach:function(t,o){var r,e;for(r=0,e=this.length;e>r;r++)t.call(o||this,this[r],r)},toArray:function(){return Array.prototype.slice.call(this,0)},$get:function(t){return this[t]},$insert:function(t){this.push(t)},$remove:function(t){t instanceof r?this.$ignore(t):this._canRemove(t)&&(bMoor.array.remove(this,t),this._remove(t))},$watch:function(t,o,r,e){var n,i;return r?(n=this.$on("insert",function(){return t.apply(r,e||arguments)}),i=this.$on("remove",function(){return o.apply(r,e||arguments)})):(n=this.$on("insert",t),i=this.$on("remove",o)),function(){n(),i()}},$follow:function(t){var o,e,n;if(t instanceof r&&(n=bMoor.data.getUid(t),this.$$following||(this.$$following={}),!this.$$following[n])){for(o=0,e=t.length;e>o;o++)this.$insert(t[o]);this.$$following[n]=t.$watch(this.$insert.bind(this),this.$remove.bind(this))}},$ignore:function(t){var o,e,n;if(t instanceof r&&(n=bMoor.data.getUid(t),this.$$following&&!this.$$following[n])){for(o=0,e=t.length;e>o;o++)this.$remove(t[o]);this.$$following[n](),this.$$following[n]=null}},$inflate:function(){var o=new t;return bMoor.loop(this,function(t,r){bMoor.isFunction(t.inflate)&&o.add(t.inflate())}),o.run(),o.promise.then(function(){return data})},$deflate:function(){var o=[],r=new t;return bMoor.loop(this,function(t,e){bMoor.isFunction(t.deflate)?r.add(t.deflate().then(function(t){o[e]=t})):o[e]=t}),r.run(),r.promise.then(function(){return o})}}}}]),bMoor.make("bmoor.data.Eventable",["bmoor.extender.Mixin",function(t){return{parent:t,properties:{$on:function(t,o){return this._$listeners||(this._$listeners={}),this._$listeners[t]||(this._$listeners[t]=[]),this._$listeners[t].push(o),function(){bMoor.array.remove(this.$$listeners[t],o)}},$trigger:function(t,o){var r,e,n;if(this._$listeners&&(r=this._$listeners[t]))for(e=0,n=r.length;n>e;e++)r[e](o)}}}}]),bMoor.make("bmoor.data.Feed",["bmoor.data.Collection",function(t){"use strict";function o(o,r){var e;this.$key=o,this._index={},r?r.push=function(t){e.$insert(t),Array.prototype.push.apply(r,arguments)}:r=[],t.apply(this,r)}return{parent:t,construct:o,properties:{$register:function(t){var o=this.$watch(t.$insert,t.$remove,t),r=this.$on("update",function(o){t.$update(o.from,o.to)});return function(){o(),r()}},_canInsert:function(t){var o=bMoor.get(this.$key,t),r=this._index[o];return r?(this.$trigger("update",{from:bMoor.object.override({},r),to:bMoor.object.override(r,t)}),!1):(bMoor.data.setUid(t),!0)}}}}]),bMoor.make("bmoor.data.Grid",[function(){"use strict";function t(){this.$array=[],this.$dex={},this.$rows=0,this.$cols=0}return{construct:t,properties:{setIndexes:function(t,o){this.primary=t,this.secondary=o},byRow:function(t,o){var r,e,n,i,s,a,u,c=[];for(e=0,n=this.$rows;n>e;e++){for(u={},i=0,s=this.$cols;s>i;i++)r=this.get(e,i),r&&t.call(u,r,i);if(o)for(a=o(u),i=0,s=this.$cols;s>i;i++)r=this._get(e,i),r&&a(r.datum,r);c.push(u)}return c},byColumn:function(t,o){var r,e,n,i,s,a,u,c=[];for(e=0,n=this.$cols;n>e;e++){for(u={},i=0,s=this.$rows;s>i;i++)r=this.get(i,e),r&&t.call(u,r,i);if(o)for(a=o(u),i=0,s=this.$rows;s>i;i++)r=this._get(i,e),r&&a(r.datum,r);c.push(u)}return c},all:function(t,o){var r,e,n,i,s,a,u={};for(e=0,n=this.$rows;n>e;e++)for(i=0,s=this.$cols;s>i;i++)r=this.get(e,i),r&&t.call(u,r,e,i);if(o)for(a=o(u),e=0,n=this.$rows;n>e;e++)for(i=0,s=this.$cols;s>i;i++)r=this._get(e,i),r&&a(r.datum,r);return u},_get:function(t,o){var r=this.$dex[t];return r?r[o]:void 0},get:function(t,o){var r=this._get(t,o);return r?r.datum:void 0},toArray:function(){var t,o,r,e,n,i=[];for(o=0,r=this.$rows;r>o;o++)for(t=[],i.push(t),e=0,n=this.$cols;n>e;e++)t.push(this.get(o,e));return i},join:function(t){bMoor.loop(t.$array,function(t){this.$insert(t.row,t.col,t.datum)},this)},$insert:function(t,o,r){var e,n;t=parseInt(t,10),o=parseInt(o,10),(!this.$rows||this.$rows<=t)&&(this.$rows=t+1),(!this.$cols||this.$cols<=o)&&(this.$cols=o+1),e=this.$dex[t],e||(e=this.$dex[t]={}),n=e[o],n?n.datum=r:(n=e[o]={row:t,col:o,datum:r},this.$array.push(n))},$remove:function(t){}}}}]),bMoor.make("bmoor.data.Node",["bmoor.data.Eventable",function(t){function o(t,o){var r,e,n;for(n=Object.keys(o),r=0,e=n.length;e>r;r++)if(!t[n[r]])return!1;return!0}return{construct:function(t){this.getData=function(){return t}},extend:[new t],properties:{_update:function(t){this.$trigger("update",t)},$update:function(t,r){var e;try{r?(bMoor.set(t,r,this.getData()),e=t):bMoor.isFunction(t)?e=t(this.getData()):bMoor.isObject(t)?!t.$$explodable&&o(this.getData(),t)?(bMoor.object.merge(this.getData(),t),e=t):(bMoor.object.explode(this.getData(),t),e=bMoor.object.explode(t)):e=this.getData(),this._update(e)}catch(n){console.log("bmoor.Node:update",n)}},$watch:function(t,o,r){return o?this.$on("update",function(){return t.apply(o,r||arguments)}):this.$on("update",t)},mount:function(t,o){bMoor.set(t,o,this.getData())}}}}]),bMoor.make("bmoor.data.collection.Filterable",["bmoor.extender.Decorator",function(t){"use strict";return{parent:t,construct:function(t){this.$filter=t},properties:{_$extend:function(o){this.$filter&&(o.$filter=this.$filter),t.prototype._$extend.call(this,o)},_canInsert:function(t){return this.$filter(t)?this.$old(t):void 0}}}}]),bMoor.make("bmoor.data.collection.Sortable",["bmoor.extender.Decorator","bmoor.flow.Regulator",function(t,o){return{parent:t,construct:function(t){this.$sorter=t},properties:{_$extend:function(o){this.$sorter&&(o.$sorter=this.$sorter),t.prototype._$extend.call(this,o)},_insert:function(t){return this.$sort||(this.$sort=o(function(t){t.$sorter&&t.sort(t.$sorter)},10,200)),this.$sort(this),this.$old(t)}}}}]),bMoor.make("bmoor.data.collection.Unique",["bmoor.extender.Decorator","bmoor.data.Collection",function(t,o){"use strict";return{parent:t,properties:{_canInsert:function(t){var o=bMoor.data.setUid(t);return this._$memory||(this._$memory={}),this._$memory[o]?(this._$memory[o]++,!1):this.$old(t)?(this._$memory[o]=1,!0):void 0},_canRemove:function(t){var o=bMoor.data.getUid(t);return this._$memory||(this._$memory={}),this._$memory[o]--,this.$old(t)&&!this._$memory[o]}}}}]);
}());